<% content_for :head do %>
  <%= javascript_include_tag "jquery.iframe-transport.1.8.2",
                             "jquery.fileupload.5.40.1",
                             "jquery.simplemodal.1.4.4.min",
                             "story"
  %>
<% end %>

<%= error_messages_for 'story' %>

<%= form_for(@story) do |f| %>
  <div class="diary_entry standard-form story_form">

    <fieldset>
      <legend>1. Describe Your Report</legend>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.title' -%></label>
        <%= f.text_field :title, :class => "richtext_title" %>
      </div>
      <div class='form-row'>
        <label class="standard-label"><%= t 'story.form.description' -%></label>
        <%= richtext_subset_area_tag "story[description]", @story.description,  :rows => 10, :format => "markdown", :class => "richtext_title"%>
      </div>
      <div class="form-row clearfix">
        <div class='form-column'>
          <label class="standard-label"><%= t 'story.form.layout' -%></label>
          <%= f.select(:layout, options_for_select(["report"],"report") ) %>
        </div>
        <div class='form-column'>
          <label class="standard-label"><%= t 'story.form.language' -%></label>
          <%= f.select(:language, options_for_select(["en"],"en") ) %>
        </div>
        <div class='form-column'>
          <label class="standard-label"><%= t 'story.form.image_url' -%></label>
          <%= f.text_field :image_url, :class => "background_url" %>
        </div>
      </div>
      <div class="form-row clearfix">
        <div class="form-column">
          <label class="standard-label"><%= t 'story.form.image' -%></label>
          <%= f.file_field :image, :id => 'report-image', :name => 'story_attachment[image]' %>
        </div>
      </div>
 
    </fieldset>

    <fieldset class='location'>
    <legend>2. Select Your Map Layers</legend>
<!--      <div><%= t 'story.form.location_hint' -%></div> -->

        <%= f.hidden_field :latitude, :size => 20, :id => "latitude", :value =>  @lat %>
        <%= f.hidden_field :longitude, :size => 20, :id => "longitude", :value => @lon  %>
        <%= f.hidden_field :zoom, :size => 20, :id => "zoom", :value => @zoom %>

      <div>

      <label class="standard-label"><%= t 'story.form.layers' -%></label>

      <ol id="tiles-available" class="layers">
      <% Tile.overlays.each { |tile|
        if ! @story.layers.include?(tile.keyid) then
          image = tile.url.sub('/{z}/{x}/{y}.png',"/5/18/16.png") # image should be property of TileAPI        
          %><li id='<%= tile.keyid %>' class="layers">
            <img src='<%= image %>' /><span><%= tile.name %></span>
          </li>
        <% end
      } %>
      </ol>

      <ol id="tiles-chosen" class="layers" >
      <% @story.layers.each { |layer|
        Tile.overlays.each { |tile|
          if (layer == tile.keyid) then
            image = tile.url.sub('/{z}/{x}/{y}.png',"/5/18/16.png")
            %><li id='<%= tile.keyid %>' class="layers">
              <img src='<%= image %>' /><span><%= tile.name %></span></li>
          <% end
        }
      } %>
      </ol>

      <div style="display:none">
        <select id="story_layers" multiple="multiple" name="story[layers][]"></select>
        <% f.select(:layers, options_from_collection_for_select(Tile.overlays, 'keyid', 'name', @story.layers), {}, {:multiple => true, :size=> "8"} ) %>
      </div>
        
      <%= t 'story.form.layers_choose_hint' %><br/>
      <span style="display:none"><%= text_field_tag "",nil , :class=>"link_input", :readonly => true   %></span> 
      <input type="button" id="set_link" class="set_link" style="width:150px" value="Preview Map Layers">

      </div>
    </fieldset>

    <!-- report -->
    <% tab = @story.body["report"] %>
    <div class="sections">
      <fieldset>
        <legend>3. Write Your Report</legend>
        <div class="sections_report" >


          <%= t "story.form.report_hint" %>
          <%= hidden_field_tag "story[body][report][title]", tab["title"] %>
          <% tab["sections"].each_with_index do | section, index | %>
            <div class="section">

              <label>Section <%= index+1 %></label>

              <% if index > 0 %>
                <input type="button" class="delete_section_button" value="Delete">
              <% end %>
              <div class='form-row'>
                <%= label_tag       "story[body][report][sections][][title]", "#{t'story.form.title'}" %>
                <%= text_field_tag "story[body][report][sections][][title]", section["title"], :rows => 8, :class => "richtext_title" %>
              </div>

              <div class='form-row'>
                <%= label_tag     "story[body][report][sections][][text]", "#{t'story.form.description'}" %>
                <%= richtext_subset_area_tag "story[body][report][sections][][text]", section["text"],  :rows => 10, :format => "markdown", :class => "richtext_title"%>
              </div>

              <% if index == 0 %>
                <% t 'story.form.first_report_section' %>
              <% end %>

              <% if index >= 0 %>
                <div class="section_link">
                  <%= t 'story.form.new_link'  %> 
                  <div class='form-row'>
                    <%= label_tag    "story[body][report][sections][][link]", "#{t 'story.form.link'}" %>
                    <%= text_field_tag "story[body][report][sections][][link]", section["link"] , :class=>"link_input", :readonly => true   %>
                    <input type="button" id="set_link" class="set_link" value="<%= t'story.form.set' %>">
                  </div>
                </div>
              <% end %>
            </div>

          <% end #section/index%>
      </fieldset>
      <%= t 'story.form.section_link_hint' %><input type="button" id="section_link_button" class="section_link" value="<%= t'story.form.section_add_button' %>">
    </div>








    <div class='form-row'>
      <label class="standard-label"><%= t 'story.form.group' -%></label>
      <%= select(:story, :group_id, @user.groups.collect {|g| [g.title, g.id]}, { :include_blank => t('story.form.no_group') }) %>
    </div>      



    <% if @story.new_record? %> 
      <%= submit_tag t('story.form.save_button') %>
    <% else %>
      <%= submit_tag t('story.form.update_button') %>
    <% end %>

  </div>

<% end %>

<!-- modal box for link form -->
<div id="links_map_box">
  <%= t 'story.form.modal_help' %>
  <div id="links_map_box_hint"></div>
  <div id="links_sorry" style="display:none;"><%= "#{t'story.form.needs_layers'}" %></div>
  <%= content_tag "div", "", :id => "links_map", :data => {:lat => @lat, :lon => @lon, :zoom => @zoom} %>
</div>

<!-- template for adding extra location site -->
<div id="story_link_template" >
  <div class="story_link">
    <label class="standard-label"><%= t 'story.form.new_link'  %> </label>
    <input type="button" class="delete_link_button" value="Delete">
    <div class='form-row'>
      <%= label_tag "story[body][sites][sections][][links][][title]", "#{t 'story.form.title'}" %>
      <%= text_field_tag "story[body][sites][sections][][links][][title]"  %>
      <%= label_tag "story[body][sites][sections][][links][][link]", "#{t 'story.form.link'}" %>
      <%= text_field_tag "story[body][sites][sections][][links][][link]", nil , :class=>"link_input" , :readonly => true   %>
      <input type="button" id="set_link" class="set_link" value="<%= t'story.form.set' %>">
    </div>

  </div>
</div>
<!-- template for adding extra report section -->
<div id="section_link_template" >
  <div class="section">
    <label><%= t 'story.form.new_section' %></label>
    <input type="button" class="delete_section_button" value="Delete">
    <div class='form-row'>
      <%= label_tag      "story[body][report][sections][][title]", "#{t'story.form.title'}" %>
      <%= text_field_tag "story[body][report][sections][][title]", nil, :rows => 8, :class => "richtext_title" %>
    </div>

    <div class='form-row'>
      <%= label_tag     "story[body][report][sections][][text]", "#{t'story.form.description'}" %>
      <%= richtext_subset_area_tag "story[body][report][sections][][text]", nil,  :rows => 10, :format => "markdown", :class => "richtext_title"%>
    </div>
    <div class="section_link">
      <%= t 'story.form.new_link'  %>
      <div class='form-row'>
        <%= label_tag "story[body][report][sections][][link]", "#{t'story.form.link'}" %>
        <%= text_field_tag "story[body][report][sections][][link]",nil , :class=>"link_input", :readonly => true   %>
        <input type="button" id="set_link" class="set_link" value="<%= t'story.form.set' %>">
      </div>
    </div>
  </div>
</div>
