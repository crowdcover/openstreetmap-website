var over_map;
var links_map;
var overlay_control;
var links_overlay_control;

$(document).ready(function() {

  var story_overlays = {
    <% overlays = Tile.overlays
      overlays.each do | tile | 
      comma = "," unless (tile==overlays.last) %>
      "<%= tile.keyid %>" : new L.Site.<%= tile.keyid.capitalize %>()<%= comma %>
    <% end %>
  };
    


  function onOverMapMove(e){
    var lat = over_map.getCenter().lat;
    var lng = over_map.getCenter().lng;
    var zoom = over_map.getZoom();
    
    $("#latitude").val(lat);
    $("#longitude").val(lng);
    $("#zoom").val(zoom);

  }
  
 
  function setUpMap() {
    $("#initial_map").show();

    var centre = [$("#latitude"),$("#longitude")];
    var position = $('html').attr('dir') === 'rtl' ? 'topleft' : 'topright';

    over_map = L.map("initial_map", {
      attributionControl: false,
      zoomControl: false
    });

    <% base_layers = Tile.base_layers
    base_layers.each do | tile | %>
      over_map.addLayer(new L.Site.<%= tile.keyid.capitalize %>());
    <% end %>

    overlay_control = new L.control.layers({}, story_overlays, {"position":"bottomright", "collapsed":false})
    overlay_control.addTo(over_map);

    L.OSM.zoom({position: position}).addTo(over_map);

    over_map.setView(centre, params.zoom);
    over_map.on('moveend', onOverMapMove);

  }

  
  
  $("#story_layers").change(function(){
    var layers = []
    
    $("#story_layers option:selected").each(function(){
      layers.push($(this).val());
    });

  });
  
  
  $('#story_link_button').click( function(e){
    add_link();
  });

  $('#section_link_button').click( function(e){
    add_section_link();
  });

  
  //setUpMap(); //No overview map any longer
  $("#story_layers").change();
  
  $(".set_link").each(function(){
    $(this).click(function(e){
      var link_field = $('.link_input', $(this).parent());
      link_modal(link_field);
    });
    
  })
  
  $("input.delete_section_button").each(function(){
      $(this).click(function(e){
      if (confirm('Are you sure?')){
          $(this).parent().remove();
        };
       });
  });
   $("input.delete_link_button").each(function(){
      $(this).click(function(e){
        if (confirm('Are you sure?')){
          $(this).parent().remove();
        };
       });
  });

 
    $('select#story_layers').on('mouseenter', 'option', function(e) {
        $('div#layer_thumb').removeClass();
        $('div#layer_thumb').addClass('thumb_'+this.value);
    });

    $( "#tiles-available, #tiles-chosen" ).sortable({   
      connectWith: ".layers",  
      stop: tile_selected
    }).disableSelection();  

    tile_selected();
});  //document.ready

function tile_selected( event, ui ) {
  var sorted = $( "#tiles-chosen" ).sortable('toArray');
  var selectVal = "";
  $.each(sorted, function( index, value ) {
    selectVal = selectVal + "<option val='" + value + "' selected>" + value;
  });
  $("#story_layers").html(selectVal); 
}

function setUpLinksMap(hash){

  var params, centre, zoom, layer_codes;
  
  if (hash != ""){
    hash_ary = hash.replace(/[A-Za-z]|=|,|&/gi, "").split("/")
    centre = [hash_ary[1], hash_ary[2]];
    zoom = hash_ary[0];
    hash_ary = hash.split("=")
    layer_codes = hash_ary[hash_ary.length - 1].split(",");
  } else{ 
    centre =  [$("#latitude")[0].value,$("#longitude")[0].value];
    zoom = $("#zoom")[0].value;
    layer_codes = [];
  }
  
  var position = $('html').attr('dir') === 'rtl' ? 'topleft' : 'topright';

  links_map = L.map("links_map", {
    attributionControl: false,
    zoomControl: false,
    scrollWheelZoom: false
  });

  var story_overlays = {
    <% overlays = Tile.overlays
      overlays.each do | tile | 
      comma = "," unless (tile==overlays.last) %>
      "<%= tile.keyid %>" : new L.Site.<%= tile.keyid.capitalize %>()<%= comma %>
    <% end %>
  };
  
  <% base_layers = Tile.base_layers
  base_layers.each do | tile | %>
    links_map.addLayer(new L.Site.<%= tile.keyid.capitalize %>());
  <% end %>
     

  L.OSM.zoom({position: position}).addTo(links_map);
  links_map.setView(centre, zoom);

  links_overlay_control = new L.control.layers({}, {}, {"position":"bottomright", "collapsed":false})
  links_overlay_control.addTo(links_map);
  
  var overlays = $("#story_layers").val();
  if (overlays && overlays.length > 0){
    for (var key in overlays) {
      if (overlays[key] in story_overlays) {
        var overlay = story_overlays[ overlays[key] ];
        if (layer_codes.indexOf(overlay.options.code) != -1) {
          overlay.addTo(links_map);
        }
        links_overlay_control.addOverlay(overlay, overlays[key]);
      };
    };
  };

}



function link_modal(ele){
 
  var val = $(ele).val();
  
  var overlays = $("#story_layers").val();
  var has_layers = true;
  if (!overlays || overlays.length < 1){
    has_layers = false;
  }
  $( "#links_map_box").modal({
        overlayClose: true,
        onShow: function (dialog){
          if (has_layers){
            $("div#links_map_box_hint").html("");
            setUpLinksMap(val);
          } else {
            var sorry =  $("div#links_sorry").html();
            $("div#links_map_box_hint").html(sorry);
          }
        },
        onClose: function(dialog){
          if (has_layers){
            var hash = map_hash();
            $(ele).val(hash);
          }
          $.modal.close();
        }
    });
}

// OSM scheme 7/-3.618/21.797&layers=B
function map_hash(){
  var lat = links_map.getCenter().lat.toFixed(5);
  var lng = links_map.getCenter().lng.toFixed(5);
  var zoom = links_map.getZoom();
  var map_layers = links_map._layers;
  var layers = [];
  for (var key in map_layers){
    layers.push(map_layers[key].options.code);
  }

  var link = "map="+zoom+"/"+lat+"/"+lng+"&layers="+layers.join(",");

  return link;
}
  
function add_link(){
  var story_link = $("#story_link_template .story_link").clone();
  $("#story_links").append(story_link);
  
   
  $(".set_link", story_link).click(function(e){
    var link_field = $('.link_input', story_link);
    link_modal(link_field);
  });  
  
   $("input.delete_link_button", story_link).click(function(e){
        if (confirm('Are you sure?')){
          $(this).parent().remove();
        };
  });

}


function add_section_link(){
    var section_link = $("#section_link_template .section").clone();
    $(".sections_report").append(section_link);
    
    $(".set_link", section_link).click(function(e){
      var link_field = $('.link_input', section_link);
      link_modal(link_field);
    });  
    
     $("input.delete_section_button", section_link).click(function(e){
      if (confirm('Are you sure?')){
          $(this).parent().remove();
        };
  });

}
